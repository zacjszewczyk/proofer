(function(global) {
  'use strict';

  // Plain English Campaign dictionary
  var pec = {"an absence of":"no, none","absence of":"no, none","abundance":"enough, plenty, a lot (or say how many)","accede to":"allow, agree to","accelerate":"speed up","accentuate":"stress","accommodation":"where you live, home","accompanying":"with","accomplish":"do, finish","according to our records":"our records show","accordingly":"in line with this, so","acknowledge":"thank you for","acquaint yourself with":"find out about, read","acquiesce":"agree","acquire":"buy, get","additional":"extra, more","adjacent":"next to","adjustment":"change, alteration","admissible":"allowed, acceptable","advantageous":"useful, helpful","advise":"tell, say (unless you are giving advice)","affix":"add, write, fasten, stick on, fix to","afford an opportunity":"let, allow","afforded":"given","aforesaid":"this, earlier in this document","aggregate":"total","aligned":"lined up, in line","alleviate":"ease, reduce","allocate":"divide, share, give","along the lines of":"like, as in","alternative":"(a) choice, (the) other","alternatively":"or, on the other hand","ameliorate":"improve, help","amendment":"change","anticipate":"expect","apparent":"clear, plain, obvious, seeming","applicant (the)":"you","application":"use","appreciable":"large, great","apprise":"inform, tell","appropriate":"proper, right, suitable","appropriate to":"suitable for","approximately":"about, roughly","as a consequence of":"because","as of the date of":"from","as regards":"about, on the subject of","ascertain":"find out","assemble":"build, gather, put together","assistance":"help","at an early date":"soon (or say when)","at its discretion":"can, may (or edit out)","at the moment":"now (or edit out)","at the present time":"now (or edit out)","attempt":"try","attend":"come to, go to, be at","attributable to":"due to, because of","authorize":"allow, let","authority":"right, power, may (as in 'have the authority to')","axiomatic":"obvious, goes without saying","belated":"late","beneficial":"helpful, useful","bestow":"give, award","breach":"break","by means of":"by","calculate":"work out, decide","cease":"finish, stop, end","circumvent":"get round, avoid, skirt, circle","clarification":"explanation, help","combine":"mix","combined":"together","commence":"start, begin","communicate":"talk, write, telephone (be specific)","competent":"able, can","compile":"make, collect","complete":"fill in, finish","completion":"end","comply with":"keep to, meet","component":"part","comprises":"is made up of, includes","(it is) compulsory":"(you) must","conceal":"hide","concerning":"about, on","conclusion":"end","concur":"agree","condition":"rule","consequently":"so","considerable":"great, important","constitutes":"makes up, forms, is","construe":"interpret","consult":"talk to, meet, ask","consumption":"amount used","contemplate":"think about","contrary to":"against, despite","correct":"put right","correspond":"write","costs the sum of":"costs","counter":"against","courteous":"polite","cumulative":"added up, added together","currently":"now (or edit out)","customary":"usual, normal","deduct":"take off, take away","deem to be":"treat as","defer":"put off, delay","deficiency":"lack of","delete":"cross out","demonstrate":"show, prove","denote":"show","depict":"show","designate":"point out, show, name","desire":"wish, want","dispatch":"send, post","despite the fact that":"though, although","determine":"decide, work out, set, end","detrimental":"harmful, damaging","difficulties":"problems","diminish":"lessen, reduce","disburse":"pay, pay out","discharge":"carry out","disclose":"tell, show","disconnect":"cut off, unplug","discontinue":"stop, end","discrete":"separate","discuss":"talk about","disseminate":"spread","documentation":"papers, documents","domiciled in":"living in","dominant":"main","due to the fact that":"because, as","duration":"time, life","during which time":"while","dwelling":"home","economical":"cheap, good value","eligible":"allowed, qualified","elucidate":"explain, make clear","emphasize":"stress","empower":"allow, let","enable":"allow","enclosed":"inside, with","(please find) enclosed":"I enclose","encounter":"meet","endeavor":"try","inquire":"ask","inquiry":"question","ensure":"make sure","entitlement":"right","envisage":"expect, imagine","equivalent":"equal, the same","erroneous":"wrong","establish":"show, find out, set up","evaluate":"test, check","evince":"show, prove","ex officio":"because of his or her position","exceptionally":"only when, in this case","excessive":"too many, too much","exclude":"leave out","excluding":"apart from, except","exclusively":"only","exempt from":"free from","expedite":"hurry, speed up","expeditiously":"as soon as possible, quickly","expenditure":"spending","expire":"run out","extant":"current, in force","extremity":"limit","fabricate":"make, make up","facilitate":"help, make possible","factor":"reason","failure to":"if you do not","finalize":"end, finish","following":"after","for the duration of":"during, while","for the purpose of":"to, for","for the reason that":"because","formulate":"plan, devise","forthwith":"now, at once","forward":"send","frequently":"often","furnish":"give","further to":"after, following","furthermore":"then, also, and","generate":"produce, give, make","give consideration to":"consider, think about","grant":"give","henceforth":"from now on, from today","hereby":"now, by this (or edit out)","herein":"here (or edit out)","hereinafter":"after this (or edit out)","hereof":"of this","hereto":"to this","heretofore":"until now, previously","hereunder":"below","herewith":"with this (or edit out)","hitherto":"until now","hold in abeyance":"wait, postpone","hope and trust":"hope, trust (but not both)","if and when":"if, when (but not both)","illustrate":"show, explain","immediately":"at once, now","implement":"carry out, do","imply":"suggest, hint at","in a number of cases":"some (or say how many)","in accordance with":"as under, in line with, because of","in addition (to)":"and, as well as, also","in advance":"before","in case of":"if","in conjunction with":"and, with","in connection with":"for, about","in consequence":"because, as a result","in excess of":"more than","in lieu of":"instead of","in order that":"so that","in receipt of":"get, have, receive","in relation to":"about","in respect of":"about, for","in the absence of":"without","in the course of":"while, during","in the event of/that":"if","in the majority of instances":"most, mostly","in the near future":"soon","in the neighborhood of":"about, around","in view of the fact that":"as, because","inappropriate":"wrong, unsuitable","inception":"start, beginning","incorporating":"which includes","incur":"have to pay, owe","indicate":"show, suggest","inform":"tell","initially":"at first","initiate":"begin, start","insert":"put in","instances":"cases","intend to":"will","intimate":"say, hint","irrespective of":"despite, even if","is of the opinion":"thinks","issue":"give, send","it is known that":"I/we know that","jeopardies":"risk, threaten","(a) large number of":"many, most (or say how many)","locality":"place, area","locate":"find, put","magnitude":"size","(it is) mandatory":"(you) must","manner":"way","manufacture":"make","marginal":"small, slight","material":"relevant","materialize":"happen, occur","may in the future":"may, might, could","merchandise":"goods","mislay":"lose","modification":"change","moreover":"and, also, as well","negligible":"very small","nevertheless":"but, however, even so","notify":"tell, let us (or you) know","notwithstanding":"even if, despite, still, yet","numerous":"many (or say how many)","objective":"aim, goal","(it is) obligatory":"(you) must","obtain":"get, receive","occasioned by":"caused by, because of","on behalf of":"for","on numerous occasions":"often","on request":"if you ask","on the grounds that":"because","on the occasion that":"when, if","operate":"work, run","optimum":"best, ideal","option":"choice","ordinarily":"normally, usually","otherwise":"or","outstanding":"unpaid","owing to":"because of","partially":"partly","participate":"join in, take part","particulars":"details, facts","per annum":"a year","perform":"do","permissible":"allowed","permit":"let, allow","personnel":"people, staff","persons":"people, anyone","peruse":"read, read carefully, look at","place":"put","possess":"have, own","possessions":"belongings","practically":"almost, nearly","predominant":"main","prescribe":"set, fix","preserve":"keep, protect","previous":"earlier, before, last","principal":"main","prior to":"before","proceed":"go ahead","procure":"get, obtain, arrange","profusion of":"plenty, too many (or say how many)","prohibit":"ban, stop","projected":"estimated","prolonged":"long","promptly":"quickly, at once","promulgate":"advertise, announce","proportion":"part","provide":"give","provided that":"if, as long as","provisions":"rules, terms","proximity":"closeness, nearness","purchase":"buy","pursuant to":"under, because of, in line with","reconsider":"think again about, look again at","reduce":"cut","reduction":"cut","referred to as":"called","refers to":"talks about, mentions","(have) regard to":"take into account","regarding":"about, on","regulation":"rule","reimburse":"repay, pay back","reiterate":"repeat, restate","relating to":"about","remain":"stay","remainder":"the rest, what is left","remittance":"payment","remuneration":"pay, wages, salary","render":"make, give, send","report":"tell","represents":"shows, stands for, is","request":"ask, question","require":"need, want, force","requirements":"needs, rules","reside":"live","residence":"home, where you live","restriction":"limit","retain":"keep","review":"look at (again)","revised":"new, changed","said/such/same":"the, this, that","scrutinize":"read (look at) carefully","select":"choose","settle":"pay","similarly":"also, in the same way","solely":"only","specified":"given, written, set","state":"say, tell us, write down","statutory":"legal, by law","subject to":"depending on, under, keeping to","submit":"send, give","subsequent to/upon":"after","subsequently":"later","substantial":"large, great, a lot of","substantially":"more or less","sufficient":"enough","supplement":"go with, add to","supplementary":"extra, more","supply":"give, sell, deliver","(the) tenant":"you","terminate":"stop, end","that being the case":"if so","the question as to whether":"whether","thereafter":"then, afterwards","thereby":"by that, because of that","therein":"in that, there","thereof":"of that","thereto":"to that","thus":"so, therefore","to date":"so far, up to now","to the extent that":"if, when","transfer":"change, move","transmit":"send","ultimately":"in the end, finally","unavailability":"lack of","undernoted":"the following","undersigned":"I, we","undertake":"agree, promise, do","uniform":"same, similar","unilateral":"one-sided, one-way","unoccupied":"empty","until such time":"until","utilization":"use","utilize":"use","variation":"change","virtually":"almost (or edit out)","visualize":"see, predict","ways and means":"ways","we have pleasure in":"we are glad to","whatsoever":"whatever, what, any","whensoever":"when","whereas":"but","whether or not":"whether","with a view to":"to, so that","with effect from":"from","with reference to":"about","with regard to":"about, for","with respect to":"about, for","with the minimum of delay":"quickly (or say when)","you are requested":"please","your attention is drawn to":"please see, please note","zone":"area, region","before too long":"soon"};

  var marked_avoid = ['a total of','absolutely','abundantly','actually','all things being equal','as a matter of fact','as far as I am concerned','at the end of the day','at this moment in time','basically','current','during the period from','each and every one','existing','extremely','I am of the opinion that','I would like to say','I would like to take this opportunity to','in due course','in the end','in the final analysis','in this connection','in total','it should be understood','last but not least','obviously','of course','other things being equal','pretty much','quite','really','really quite','regarding the','the fact of the matter is','the month of','the months of','to all intents and purposes',"to one's own mind",'very'];

  var marked_alternate = ['a large number of','a number of','accompany','accorded','accrue','adjacent to','adversely impact','aforementioned','aircraft','all of','already existing','applicant','as a means of','as of yet','as to','as yet','assemble assistance','at this time','attain','authority to','because of the fact that','benefit from','by virtue of','close proximity','comprise','compulsory','consolidate','constitute','depart','due to the fact of','each and every','eliminate','employ','enumerate','equitable','evidenced','expend','expiration','factual evidence','feasible','first and foremost','forfeit','honest truth','however','impacted','in a timely manner','in addition to','in addition','in all likelihood','in an effort to','in between','in light of the fact that','in many cases','in order to','in regard to','in some instances','in terms of','in the event of','in the event that','in the process of','incumbent upon','incurred','indication','is applicable to','is authorized to','is in accordance with','is responsible for','it is essential','jeopardize','liaise with','mandatory','maximum','methodology','minimize','minimum','modify','monitor','multiple','necessitate','not certain','not many','not often','not unless','not unlike','null and void','obligate','obligatory','on receipt of','on the contrary','on the other hand','one particular','overall','owing to the fact that','pass away','percentage of','pertaining to','please find enclosed','point in time','portion','preclude','previously','prioritize','proficiency','progress something','put simply','qualify for','readily apparent','refer back','refer to','regard to','relocate','represent','requirement','satisfy','shall','should you wish','similar to','solicit','span across','strategize','subsequent','subsequent to','subsequent upon','successfully complete','take pleasure in','tenant','the month of','therefore','time period','took advantage of','transpire','until such time as','validate','various different','very','whilst','with the exception of','witnessed','your attention is drawn'];

  var be_verbs = ["am", "is", "are", "was", "were", "be", "being", "been", "you're", "they're"];

  var exclude = ["the", "a", "or", "my", "and", "to", "we", "an", "at", "I", "for", "i", "what", "of", "that", "he", "she", "it", "you", "your", "have", "which", "in", "on", "with", "would", "as", "had", "s"];

  var transition_words = ["accordingly","additionally","afterward","afterwards","also","although","besides","consequently","conversely","finally","furthermore","hence","however","indeed","instead","likewise","meanwhile","moreover","namely","nevertheless","next","nonetheless","notably","otherwise","overall","similarly","specifically","still","subsequently","then","thereafter","therefore","thus","ultimately","whereas","yet"];

  var transition_regexps = [];
  for (var twri = 0; twri < transition_words.length; twri++) {
    transition_regexps.push(new RegExp('\\b' + transition_words[twri].replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'g'));
  }

  var adverb_exceptions = ["only","early","family","holy","lily","fly","apply","supply","reply","rely","comply","imply","multiply","rally","tally","july","italy","daily","weekly","monthly","yearly","friendly","lonely","lovely","likely","lively","deadly","elderly","orderly","costly","ghostly","scholarly","worldly","silly","belly","bully","hilly","jolly","jelly","ally","homily","melancholy"];

  // Hedge words - wishy-washy language that weakens writing
  var hedge_words = ["might","maybe","perhaps","somewhat","probably","possibly","seems","appeared","appears","tend","tends","roughly","generally","typically","apparently","presumably","supposedly","conceivably","arguably","fairly","seemingly","relatively","largely","mostly","hopefully"];

  // Nominalizations - nouns that could be stronger as verbs
  var nominalizations = {"utilization":"use","implementation":"implement","establishment":"establish","development":"develop","improvement":"improve","assessment":"assess","management":"manage","achievement":"achieve","requirement":"require","measurement":"measure","involvement":"involve","enhancement":"enhance","encouragement":"encourage","authorization":"authorize","consideration":"consider","determination":"determine","examination":"examine","explanation":"explain","recommendation":"recommend","investigation":"investigate","notification":"notify","observation":"observe","preparation":"prepare","continuation":"continue","elimination":"eliminate","clarification":"clarify","communication":"communicate","demonstration":"demonstrate","documentation":"document","distribution":"distribute","facilitation":"facilitate","presentation":"present","transformation":"transform","conclusion":"conclude","provision":"provide","permission":"allow","submission":"submit","acquisition":"get","assumption":"assume","completion":"finish","collection":"collect","description":"describe","discussion":"discuss","expansion":"expand","expression":"express","introduction":"introduce","production":"produce","protection":"protect","reduction":"reduce","selection":"choose","suggestion":"suggest"};

  // Weak openings regex
  var weak_opener_re = /^(there\s+(is|are|was|were|have\s+been|has\s+been)|it\s+(is|was|seems|appears))\b/i;

  // Clichés to detect
  var cliches = ["at the end of the day","think outside the box","low-hanging fruit","back to the drawing board","hit the ground running","get the ball rolling","raise the bar","move the needle","paradigm shift","synergy","circle back","take it to the next level","deep dive","best practice","game changer","win-win","on the same page","push the envelope","break the mold","cutting edge","state of the art","touch base","bottom line","value added","going forward","leverage","bring to the table","drill down","take away","run it up the flagpole","net-net","boil the ocean","peel the onion","open the kimono","at this point in time","when all is said and done","it goes without saying","needless to say","in today's world","each and every","first and foremost","in terms of","with regard to","point in time","due to the fact that","in the event that","for all intents and purposes","by and large","few and far between","in light of","as a matter of fact","for what it's worth","it is what it is","at the present time","in the near future","in the not too distant future"];

  // Syllable counting - exact port from Python
  function syllables(word) {
    word = word.toLowerCase();

    var syls = 0;
    var disc = 0;

    // Rule 1: three or fewer letters = 1 syllable
    if (word.length <= 3) {
      return 1;
    }

    // Rule 2: discount "es"/"ed" endings
    var double_vowel = (word.match(/[eaoui][eaoui]/g) || []).length;

    var ending2 = word.slice(-2);
    if (ending2 === 'es' || ending2 === 'ed') {
      var cv = (word.match(/[eaoui][^eaoui]/g) || []).length;
      if (double_vowel > 1 || cv > 1) {
        var ending3 = word.slice(-3);
        if (ending3 !== 'ted' && ending3 !== 'tes' && ending3 !== 'ses' && ending3 !== 'ied' && ending3 !== 'ies') {
          disc += 1;
        }
      }
    }

    // Rule 3: discount trailing "e", except "le" words (with exceptions)
    if (word.slice(-1) === 'e') {
      var le_exceptions = ['whole','mobile','pole','male','female','hale','pale','tale','sale','aisle','whale','while'];
      if (word.slice(-2) === 'le' && le_exceptions.indexOf(word) === -1) {
        // keep - don't discount
      } else {
        disc += 1;
      }
    }

    // Rule 4: discount consecutive vowel pairs and triplets
    disc += double_vowel + (word.match(/[eaoui][eaoui][eaoui]/g) || []).length;

    // Rule 5: count remaining vowels
    var numVowels = (word.match(/[eaoui]/g) || []).length;

    // Rule 6: +1 for "mc" prefix
    if (word.slice(0, 2) === 'mc') {
      syls += 1;
    }

    // Rule 7: +1 for "y" ending not preceded by vowel
    if (word.slice(-1) === 'y' && 'aeoui'.indexOf(word[word.length - 2]) === -1) {
      syls += 1;
    }

    // Rule 8: +1 for "y" surrounded by non-vowels (not at start/end)
    for (var i = 0; i < word.length; i++) {
      if (word[i] === 'y') {
        if (i !== 0 && i !== word.length - 1) {
          if ('aeoui'.indexOf(word[i - 1]) === -1 && 'aeoui'.indexOf(word[i + 1]) === -1) {
            syls += 1;
          }
        }
      }
    }

    // Rule 9: +1 for "tri-"/"bi-" prefix followed by vowel
    if (word.slice(0, 3) === 'tri' && 'aeoui'.indexOf(word[3]) !== -1) {
      syls += 1;
    }
    if (word.slice(0, 2) === 'bi' && 'aeoui'.indexOf(word[2]) !== -1) {
      syls += 1;
    }

    // Rule 10: +1 for "-ian" ending (except "-tian", "-cian")
    if (word.slice(-3) === 'ian') {
      var ending4 = word.slice(-4);
      if (ending4 !== 'cian' && ending4 !== 'tian') {
        syls += 1;
      }
    }

    // Rule 11: "co-" prefix followed by vowel
    if (word.slice(0, 2) === 'co' && 'eaoui'.indexOf(word[2]) !== -1) {
      var prefixes = [word.slice(0, 4), word.slice(0, 5), word.slice(0, 6)];
      var doubleSyl = ['coapt','coed','coinci'];
      var singleSyl = ['cool','coach','coat','coal','count','coin','coarse','coup','coif','cook','coign','coiffe','coof','court'];
      if (doubleSyl.some(function(w) { return prefixes.indexOf(w) !== -1; })) {
        syls += 1;
      } else if (singleSyl.some(function(w) { return prefixes.indexOf(w) !== -1; })) {
        // pass
      } else {
        syls += 1;
      }
    }

    // Rule 12: "pre-" prefix followed by vowel
    if (word.slice(0, 3) === 'pre' && 'eaoui'.indexOf(word[3]) !== -1) {
      if (word.slice(0, 6) !== 'preach') {
        syls += 1;
      }
    }

    // Rule 13: "-n't" contractions
    if (word.slice(-3) === "n't") {
      var nts = ["doesn't", "isn't", "shouldn't", "couldn't", "wouldn't"];
      if (nts.indexOf(word) !== -1) {
        syls += 1;
      }
    }

    // Rule 14: exception words
    if (word === 'fortunately' || word === 'unfortunately') {
      disc += 1;
    }
    if (word === 'serious' || word === 'crucial') {
      syls += 1;
    }

    var result = numVowels - disc + syls;
    return result < 1 ? 1 : result;
  }

  // Simplified Markdown-to-HTML parser
  function parseMarkdown(line) {
    if (!line) return '';

    // Code blocks
    if (line.slice(0, 3) === '```') {
      return '';
    }

    // Horizontal rules
    if (line === '---' || line === '* * *' || /^-{3,}$/.test(line)) {
      return '<hr />';
    }

    // Headers
    var headerMatch = line.match(/^(#{1,6})\s+(.*)/);
    if (headerMatch) {
      var level = headerMatch[1].length;
      return '<h' + level + '>' + parseInline(headerMatch[2]) + '</h' + level + '>';
    }

    // Blockquotes
    if (line[0] === '>') {
      return '<blockquote><p>' + parseInline(line.slice(1).trim()) + '</p></blockquote>';
    }

    // Unordered lists
    if (/^[\*\+\-]\s+/.test(line)) {
      return '<li>' + parseInline(line.replace(/^[\*\+\-]\s+/, '')) + '</li>';
    }

    // Ordered lists
    if (/^\d+\.\s+/.test(line)) {
      return '<li>' + parseInline(line.replace(/^\d+\.\s+/, '')) + '</li>';
    }

    // Default: paragraph
    return '<p>' + parseInline(line) + '</p>';
  }

  function parseInline(text) {
    // Bold
    text = text.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
    // Italic
    text = text.replace(/\*([^\*]+)\*/g, '<em>$1</em>');
    // Inline code
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Links
    text = text.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2">$1</a>');
    return text;
  }

  // Strip HTML tags and unescape entities for text analysis
  function stripHtml(html) {
    if (typeof document !== 'undefined') {
      var el = document.createElement('div');
      el.innerHTML = html;
      return el.textContent || el.innerText || '';
    }
    // Node.js fallback: iteratively strip tags then unescape entities
    var text = html;
    var prev;
    do {
      prev = text;
      text = text.replace(/<[^>]*>/g, '');
    } while (text !== prev);
    var entityMap = {'&amp;': '&', '&lt;': '<', '&gt;': '>', '&quot;': '"', '&#39;': "'"};
    return text.replace(/&amp;|&lt;|&gt;|&quot;|&#39;/g, function(match) { return entityMap[match]; });
  }

  function escapeRegExp(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function replaceWholeWord(str, word, replacement) {
    var re = new RegExp('\\b' + escapeRegExp(word) + '\\b', 'g');
    return str.replace(re, replacement);
  }

  // Main analyze function
  function analyze(text) {
    var word_count = 0;
    var sentence_count = 0;
    var paragraph_count = 0;
    var overused_phrase_count = 0;
    var repeated_word_count = 0;
    var avoid_word_count = 0;
    var complex_words = 0;
    var syllable_count = 0;
    var char_count = 0;
    var adverb_count = 0;
    var passive_voice_count = 0;
    var transition_word_count = 0;
    var hedge_word_count = 0;
    var nominalization_count = 0;
    var weak_opening_count = 0;
    var cliche_count = 0;
    var be_verb_count = 0;
    var all_words_set = {};
    var all_sentences = [];
    var sentence_starts = [];
    var paragraph_sentence_counts = [];
    var current_para_sentences = 0;

    var lines = text.split('\n');
    var htmlLines = [];
    var skip = exclude.concat(be_verbs);

    for (var li = 0; li < lines.length; li++) {
      var line = lines[li].trim();

      // Parse Markdown line into HTML
      var html_line = parseMarkdown(line);

      // Strip HTML to get plain text
      var text_line = stripHtml(html_line);

      // Character count (excluding spaces)
      char_count += text_line.replace(/\s/g, '').length;

      // Increment paragraph count for non-empty, non-header lines
      var is_paragraph = (line.length !== 0 && line[0] !== '#');
      if (is_paragraph) {
        paragraph_count += 1;
      }

      // Tokenize
      var tokens = text_line.split(/\W/);

      // Unique tokens
      var tokens_set = {};
      for (var ti = 0; ti < tokens.length; ti++) {
        if (tokens[ti]) tokens_set[tokens[ti]] = true;
      }
      var unique_tokens = Object.keys(tokens_set);

      // Per-word flags: collect all classes and tooltips before highlighting
      var word_flags = {}; // lowercase -> {word, classes[], tooltip}
      function addFlag(word, cls, tip) {
        var key = word.toLowerCase();
        if (!word_flags[key]) word_flags[key] = {word: word, classes: [], tooltip: ''};
        if (word_flags[key].classes.indexOf(cls) === -1) word_flags[key].classes.push(cls);
        if (tip) {
          if (word_flags[key].tooltip) word_flags[key].tooltip += '; ' + tip;
          else word_flags[key].tooltip = tip;
        }
      }

      // Count syllables, complex words, word count
      for (var wi = 0; wi < tokens.length; wi++) {
        var w = tokens[wi];
        if (!/^[a-zA-Z]+$/.test(w)) continue;
        var wl = w.toLowerCase();
        var sylls = syllables(w);
        syllable_count += sylls;
        if (sylls >= 3) {
          complex_words += 1;
          addFlag(w, 'long', 'Complex word (' + sylls + ' syllables). Consider a simpler alternative.');
        }
        word_count += 1;
        all_words_set[wl] = true;

        // Detect adverbs (-ly words)
        if (wl.length > 3 && wl.slice(-2) === 'ly' && adverb_exceptions.indexOf(wl) === -1) {
          adverb_count++;
          addFlag(w, 'adverb', 'Adverb. Consider removing or using a stronger verb instead.');
        }

        // Detect hedge words
        if (hedge_words.indexOf(wl) !== -1) {
          hedge_word_count++;
          addFlag(w, 'hedge', 'Hedge word. Consider being more direct and assertive.');
        }

        // Detect nominalizations
        if (nominalizations.hasOwnProperty(wl)) {
          nominalization_count++;
          addFlag(w, 'nominalization', 'Nominalization. Try the verb form: "' + nominalizations[wl] + '"');
        }
      }

      // Detect passive voice (be_verb + past participle) and highlight
      for (var pvi = 0; pvi < tokens.length - 1; pvi++) {
        var pvw1 = tokens[pvi].toLowerCase();
        var pvw2 = tokens[pvi + 1].toLowerCase();
        if (be_verbs.indexOf(pvw1) !== -1 && pvw2.length > 2) {
          if (pvw2.slice(-2) === 'ed' || pvw2.slice(-2) === 'en' || pvw2.slice(-3) === 'ung' || pvw2.slice(-3) === 'ght') {
            passive_voice_count++;
            addFlag(tokens[pvi + 1], 'passive', 'Passive voice. Consider rewriting in active voice.');
          }
        }
      }

      // Find duplicates (>2 occurrences in paragraph, excluding common words)
      for (var ui = 0; ui < unique_tokens.length; ui++) {
        var uw = unique_tokens[ui];
        if (uw.length === 0) continue;
        if (skip.indexOf(uw) !== -1) continue;
        var count = 0;
        for (var ci = 0; ci < tokens.length; ci++) {
          if (tokens[ci] === uw) count++;
        }
        if (count > 2) {
          addFlag(uw, 'dup', 'Repeated ' + count + ' times in this paragraph.');
          repeated_word_count += 1;
        }
      }

      // Classify be verbs, pec words, avoid words, alternate words
      for (var ei = 0; ei < unique_tokens.length; ei++) {
        var each = unique_tokens[ei];
        if (!/^[a-zA-Z]+$/.test(each)) continue;
        if (exclude.indexOf(each) !== -1) continue;
        var eachLower = each.toLowerCase();

        if (be_verbs.indexOf(eachLower) !== -1) {
          avoid_word_count += 1;
          be_verb_count += 1;
          addFlag(each, 'avoid', 'Weak verb. Consider using a more descriptive action verb.');
        } else if (pec.hasOwnProperty(eachLower)) {
          overused_phrase_count += 1;
          addFlag(each, 'trite', 'Consider replacing with: ' + pec[eachLower]);
        } else if (marked_avoid.indexOf(eachLower) !== -1) {
          avoid_word_count += 1;
          addFlag(each, 'avoid', 'Weak or filler word. Try removing it or finding a stronger alternative.');
        } else if (marked_alternate.indexOf(eachLower) !== -1) {
          overused_phrase_count += 1;
          addFlag(each, 'alternate', 'Overused phrase. Consider a simpler, more direct alternative.');
        }
      }

      // Apply combined highlighting (single span per word with all classes)
      for (var fk in word_flags) {
        if (!word_flags.hasOwnProperty(fk)) continue;
        var f = word_flags[fk];
        var classes = f.classes.join(' ');
        if (f.classes.length > 1) classes += ' multi-flag';
        if (f.tooltip) {
          html_line = replaceWholeWord(html_line, f.word, "<span class='" + classes + " tooltip'>" + f.word + "<span class='tooltiptext'>" + f.tooltip + "</span></span>");
        } else {
          html_line = replaceWholeWord(html_line, f.word, "<span class='" + classes + "'>" + f.word + "</span>");
        }
      }

      // Count sentences
      var line_sentence_count = 0;
      for (var si = 0; si < text_line.length; si++) {
        var ch = text_line[si];
        if (ch === '.' || ch === ';' || ch === '!' || ch === '?') {
          sentence_count += 1;
          line_sentence_count += 1;
        }
      }

      // Track sentences per paragraph
      if (is_paragraph && line_sentence_count > 0) {
        current_para_sentences += line_sentence_count;
      }
      if (line.length === 0 && current_para_sentences > 0) {
        paragraph_sentence_counts.push(current_para_sentences);
        current_para_sentences = 0;
      }

      // Collect sentence lengths, starting words, and check for weak openings
      var sentencesInLine = text_line.split(/[.;!?]+/);
      for (var sli = 0; sli < sentencesInLine.length; sli++) {
        var sentText = sentencesInLine[sli].trim();
        if (!sentText) continue;
        var sentWords = sentText.split(/\s+/).filter(function(sw) { return sw.length > 0; });
        if (sentWords.length > 0) {
          all_sentences.push(sentWords.length);
          sentence_starts.push(sentWords[0].toLowerCase().replace(/[^a-z]/g, ''));
        }
        // Detect weak openings
        if (weak_opener_re.test(sentText)) {
          weak_opening_count++;
        }
      }

      // Count transition words
      var text_lower = text_line.toLowerCase();
      for (var twi = 0; twi < transition_regexps.length; twi++) {
        transition_regexps[twi].lastIndex = 0;
        var twMatches = text_lower.match(transition_regexps[twi]);
        if (twMatches) transition_word_count += twMatches.length;
      }

      // Detect clichés in the line
      for (var cli = 0; cli < cliches.length; cli++) {
        var clicheLower = cliches[cli];
        var clicheIdx = text_lower.indexOf(clicheLower);
        if (clicheIdx !== -1) {
          cliche_count++;
        }
      }

      htmlLines.push(html_line);
    }

    // Flush last paragraph sentence count
    if (current_para_sentences > 0) {
      paragraph_sentence_counts.push(current_para_sentences);
    }

    // Vocabulary diversity (type-token ratio)
    var unique_word_count = Object.keys(all_words_set).length;
    var vocabulary_diversity = word_count > 0 ? (unique_word_count / word_count * 100) : 0;

    // Long sentences (>25 words)
    var long_sentence_count = 0;
    for (var lsi = 0; lsi < all_sentences.length; lsi++) {
      if (all_sentences[lsi] > 25) long_sentence_count++;
    }

    // Repeated sentence starts (consecutive sentences beginning with the same word)
    var repeated_starts = 0;
    for (var rsi = 1; rsi < sentence_starts.length; rsi++) {
      if (sentence_starts[rsi] && sentence_starts[rsi] === sentence_starts[rsi - 1]) repeated_starts++;
    }

    // Sentence length variation (standard deviation)
    var sentence_std_dev = 0;
    if (all_sentences.length > 1) {
      var sent_sum = 0;
      for (var smi = 0; smi < all_sentences.length; smi++) {
        sent_sum += all_sentences[smi];
      }
      var sent_mean = sent_sum / all_sentences.length;
      var sumSquares = 0;
      for (var sdi = 0; sdi < all_sentences.length; sdi++) {
        sumSquares += (all_sentences[sdi] - sent_mean) * (all_sentences[sdi] - sent_mean);
      }
      sentence_std_dev = Math.sqrt(sumSquares / all_sentences.length);
    }

    // Reading time (average 238 words per minute)
    var reading_time_seconds = word_count > 0 ? Math.ceil(word_count / 238 * 60) : 0;
    var reading_time_min = Math.floor(reading_time_seconds / 60);
    var reading_time_sec = reading_time_seconds % 60;
    var reading_time_display = reading_time_min > 0 ? (reading_time_min + 'm ' + reading_time_sec + 's') : (reading_time_sec + 's');

    // Speaking time (average 150 words per minute)
    var speaking_time_seconds = word_count > 0 ? Math.ceil(word_count / 150 * 60) : 0;
    var speaking_time_min = Math.floor(speaking_time_seconds / 60);
    var speaking_time_sec = speaking_time_seconds % 60;
    var speaking_time_display = speaking_time_min > 0 ? (speaking_time_min + 'm ' + speaking_time_sec + 's') : (speaking_time_sec + 's');

    // Sentences per paragraph
    var avg_sentences_per_paragraph = paragraph_sentence_counts.length > 0 ?
      (function() { var s = 0; for (var i = 0; i < paragraph_sentence_counts.length; i++) s += paragraph_sentence_counts[i]; return s / paragraph_sentence_counts.length; })() : 0;

    // Longest sentence
    var longest_sentence = 0;
    for (var lsi2 = 0; lsi2 < all_sentences.length; lsi2++) {
      if (all_sentences[lsi2] > longest_sentence) longest_sentence = all_sentences[lsi2];
    }

    // Short sentences (<5 words) - can indicate choppy writing
    var short_sentence_count = 0;
    for (var ssi = 0; ssi < all_sentences.length; ssi++) {
      if (all_sentences[ssi] < 5 && all_sentences[ssi] > 0) short_sentence_count++;
    }

    // Be-verb percentage
    var be_verb_pct = word_count > 0 ? (be_verb_count / word_count * 100) : 0;

    // Calculate readability stats (guard against division by zero)
    var fog_index = 0;
    var reading_ease = 0;
    var grade_level = 0;
    var reading_ease_class = '';

    if (sentence_count > 0 && word_count > 0) {
      fog_index = 0.4 * (word_count / sentence_count + 100.0 * complex_words / word_count);
      reading_ease = 206.835 - 1.015 * (word_count / sentence_count) - 84.6 * (syllable_count / word_count);
      grade_level = 0.39 * word_count / sentence_count + 11.8 * syllable_count / word_count - 15.59;

      if (reading_ease <= 30) reading_ease_class = 'extreme';
      else if (reading_ease <= 50) reading_ease_class = 'hard';
      else if (reading_ease <= 60) reading_ease_class = 'tough';
      else if (reading_ease <= 70) reading_ease_class = 'plain';
      else if (reading_ease <= 80) reading_ease_class = 'fair';
      else if (reading_ease <= 90) reading_ease_class = 'easy';
      else if (reading_ease <= 100) reading_ease_class = 'simple';
    }

    return {
      html: htmlLines.join('\n'),
      stats: {
        word_count: word_count,
        sentence_count: sentence_count,
        paragraph_count: paragraph_count,
        syllable_count: syllable_count,
        complex_words: complex_words,
        overused_phrase_count: overused_phrase_count,
        repeated_word_count: repeated_word_count,
        avoid_word_count: avoid_word_count,
        fog_index: fog_index,
        reading_ease: reading_ease,
        grade_level: grade_level,
        reading_ease_class: reading_ease_class,
        avg_words_per_paragraph: paragraph_count > 0 ? word_count / paragraph_count : 0,
        avg_words_per_sentence: sentence_count > 0 ? word_count / sentence_count : 0,
        avg_syllables_per_sentence: sentence_count > 0 ? syllable_count / sentence_count : 0,
        avg_syllables: word_count > 0 ? syllable_count / word_count : 0,
        char_count: char_count,
        adverb_count: adverb_count,
        passive_voice_count: passive_voice_count,
        transition_word_count: transition_word_count,
        vocabulary_diversity: vocabulary_diversity,
        long_sentence_count: long_sentence_count,
        repeated_starts: repeated_starts,
        sentence_std_dev: sentence_std_dev,
        reading_time_display: reading_time_display,
        speaking_time_display: speaking_time_display,
        hedge_word_count: hedge_word_count,
        nominalization_count: nominalization_count,
        weak_opening_count: weak_opening_count,
        cliche_count: cliche_count,
        avg_sentences_per_paragraph: avg_sentences_per_paragraph,
        longest_sentence: longest_sentence,
        short_sentence_count: short_sentence_count,
        be_verb_pct: be_verb_pct
      }
    };
  }

  global.Proofer = {
    syllables: syllables,
    analyze: analyze,
    parseMarkdown: parseMarkdown
  };

})(typeof window !== 'undefined' ? window : this);
